#!/bin/bash -v
export LOCALIP=$(curl -s http://169.254.169.254/latest/meta-data/local-ipv4)
export INSTANCEID=$(curl -s http://169.254.169.254/latest/meta-data/instance-id 2>/dev/null)
export INSTANCE_MAC_ADDR=$(curl -s http://169.254.169.254/latest/meta-data/mac)
export INSTANCE_SUBNET_ID=$(curl -s http://169.254.169.254/latest/meta-data/network/interfaces/macs/$INSTANCE_MAC_ADDR/subnet-id)
export admin_pass=${admin_password}
case $INSTANCE_SUBNET_ID in 
${private_subnet_1}) site=site1;;
${private_subnet_2}) site=site2;;
*) echo "Unexpected subnet id";;
esac
export INSTANCE_TYPE=$(aws ec2 describe-instances --instance-id $INSTANCEID --region sa-east-1 --output text --query 'Reservations[*].Instances[*].InstanceType')
#Monta o Storage NVME de acordo com o Tipo da Instancia

case $INSTANCE_TYPE in 
*c5d*) 
mkdir /data
sudo mkfs -t xfs /dev/nvme1n1
sudo blkid /dev/nvme1n1
UUID=$(sudo blkid /dev/nvme1n1 | grep -Po '(?s)(?<=UUID=").*?(?=")')
sudo cat >>/etc/fstab <<end
UUID=$UUID     /data       xfs    defaults,nofail   0   2
end
mount -a
chown splunk:splunk /data
;;
*i3*) 
mkdir /data
sudo mkfs -t xfs /dev/nvme0n1
sudo blkid /dev/nvme0n1
UUID=$(sudo blkid /dev/nvme0n1 | grep -Po '(?s)(?<=UUID=").*?(?=")')
sudo cat >>/etc/fstab <<end
UUID=$UUID     /data       xfs    defaults,nofail   0   2
end
mount -a
chown splunk:splunk /data

mkdir /data_1
sudo mkfs -t xfs /dev/nvme1n1
sudo blkid /dev/nvme1n1
UUID=$(sudo blkid /dev/nvme1n1 | grep -Po '(?s)(?<=UUID=").*?(?=")')
sudo cat >>/etc/fstab <<end
UUID=$UUID     /data_1       xfs    defaults,nofail   0   2
end
mount -a
chown splunk:splunk /data_1
;;
*) echo "Unexpected subnet id";;
esac


while STATE=$(aws --no-verify-ssl ec2 describe-instances --region sa-east-1 --filters "Name=tag:Name,Values=Splunk-Master" "Name=instance-state-name,Values=running" --output text --query 'Reservations[*].Instances[*].State.Name'); test "$STATE" != "running"; do
    sleep 5;
    echo "Splunk-Master - Aguardando..."
done;
echo "Splunk-Master Iniciada"
aws --no-verify-ssl ec2 describe-instances --region sa-east-1 --filters "Name=tag:Name,Values=Splunk-Master" "Name=instance-state-name,Values=running" --output text --query 'Reservations[*].Instances[*].PrivateIpAddress'
export MASTER_IP=$(aws --no-verify-ssl ec2 describe-instances --region sa-east-1 --filters "Name=tag:Name,Values=Splunk-Master" "Name=instance-state-name,Values=running" --output text --query 'Reservations[*].Instances[*].PrivateIpAddress')
echo $MASTER_IP


sudo cat >>/home/splunk/splunk_temp.sh<<end1

#!/bin/bash -v

sleep 300

if [ -d "/data" ]
then
#Movimentação do SPLUNK_DB
sudo -u splunk /opt/splunk/bin/splunk stop
sudo -u splunk cp -R /opt/splunk/var/lib/splunk /data 
sudo -u splunk rm -Rf /opt/splunk/var/lib/splunk
sudo -u splunk cat >>/opt/splunk/etc/splunk-launch.conf <<END
SPLUNK_DB=/data
END
sudo -u splunk /opt/splunk/bin/splunk start

echo "Diretorio Movimentado" >> /home/splunk/splunk.log

else
echo "Diretorio Não Existe" >> /home/splunk/splunk.log
fi

sleep 60

# Alteração da senha de admin
sudo mv /opt/splunk/etc/passwd /opt/splunk/etc/passwd.bak
sudo cat >>/opt/splunk/etc/system/local/user-seed.conf<<end
[user_info]
USERNAME = admin
PASSWORD = $admin_pass
end

sudo sed -i '/guid/d' /opt/splunk/etc/instance.cfg
sudo -u splunk touch /opt/splunk/etc/.ui_login
sudo -u splunk /opt/splunk/bin/splunk edit user admin -password '$admin_pass' -role admin -auth admin:SPLUNK-$INSTANCEID

echo "Alteração de senha usuario" >> /home/splunk/splunk.log

sudo /opt/splunk/bin/splunk stop
sleep 60

#Alteração do ulimit do Linux e adicionando o splunk no boot-start
sudo /opt/splunk/bin/splunk disable boot-start
sudo /opt/splunk/bin/splunk enable boot-start -user splunk -systemd-managed 0

echo "Adicionando Splunk no boot start" >> /home/splunk/splunk.log

sed -i '/init.d\/functions/a ulimit -Sn 32768' /etc/init.d/splunk
sed -i '/init.d\/functions/a ulimit -Hn 65536' /etc/init.d/splunk

sudo cat >>/etc/security/limits.conf<<end
#splunk
root        soft    nofile           64000
root        hard    nofile           64000
root        hard    nproc            16000
root        hard    fsize            -1  
splunk      soft    nofile           64000
splunk      hard    nofile           64000
splunk      hard    nproc            16000
splunk      hard    fsize            -1  
 
end

echo "Alteração dos ulimit" >> /home/splunk/splunk.log

sudo -u splunk /opt/splunk/bin/splunk restart
sleep 120

echo "Restart 1" >> /home/splunk/splunk.log


# Aumento do tempo de timeout
mkdir -p /opt/splunk/etc/apps/base-autogenerated/local
sudo -u splunk cat >>/opt/splunk/etc/apps/base-autogenerated/local/web.conf <<end
[settings]
splunkdConnectionTimeout = 300
enableWebDebug = True
enableSplunkWebSSL = True
end

# Habilitar o index auto discovery
sudo -u splunk cat >>/opt/splunk/etc/apps/base-autogenerated/local/server.conf <<end
[shclustering]
register_replication_address = $LOCALIP
end

echo "Alteracao do webservice" >> /home/splunk/splunk.log

sudo chown -R splunk:splunk /opt/splunk/etc/apps/base-autogenerated
sudo -u splunk /opt/splunk/bin/splunk edit licenser-localslave -master_uri https://$MASTER_IP:8089 -auth admin:'$admin_pass'

echo "Indicação da license" >> /home/splunk/splunk.log


sudo -u splunk /opt/splunk/bin/splunk restart

echo "Restart 2" >> /home/splunk/splunk.log

sleep 120

sudo -u splunk /opt/splunk/bin/splunk edit cluster-config -mode slave -site $site -master_uri https://$MASTER_IP:8089  -replication_port 9887  -secret '$admin_pass' -auth admin:'$admin_pass'

echo "Indicacao da Master" >> /home/splunk/splunk.log

sudo -u splunk /opt/splunk/bin/splunk restart

echo "Restart 3" >> /home/splunk/splunk.log

rm -f /home/splunk/splunk_temp.sh

echo "Remoção do Splunk_temp.sh" >> /home/splunk/splunk.log

end1

chmod 777 /home/splunk/splunk_temp.sh
chmod 777 /home/splunk/montagem_s3.sh
at -f /home/splunk/montagem_s3.sh now + 3 minute
at -f /home/splunk/splunk_temp.sh now + 10 minute

