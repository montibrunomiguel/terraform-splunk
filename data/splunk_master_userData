#!/bin/bash -v
export LOCALIP=$(curl -s http://169.254.169.254/latest/meta-data/local-ipv4)
export INSTANCEID=$(curl -s http://169.254.169.254/latest/meta-data/instance-id 2>/dev/null)
export INSTANCE_TYPE=$(aws ec2 describe-instances --instance-id $INSTANCEID --region sa-east-1 --output text --query 'Reservations[*].Instances[*].InstanceType')
export MASTER_IP=$(aws --no-verify-ssl ec2 describe-instances --region sa-east-1 --filters "Name=tag:Name,Values=Splunk-Master" | grep -oP '(?<="PrivateIpAddress": ")[^"]*' -m 1)
export admin_pass=${admin_password}
#Monta o Storage NVME de acordo com o Tipo da Instancia

case $INSTANCE_TYPE in 
*c5d*) 
mkdir /data
sudo mkfs -t xfs /dev/nvme1n1
sudo blkid /dev/nvme1n1
UUID=$(sudo blkid /dev/nvme1n1 | grep -Po '(?s)(?<=UUID=").*?(?=")')
sudo cat >>/etc/fstab <<end
UUID=$UUID     /data       xfs    defaults,nofail   0   2
end
mount -a
chown splunk:splunk /data
;;
*i3*) 
mkdir /data
sudo mkfs -t xfs /dev/nvme0n1
sudo blkid /dev/nvme0n1
UUID=$(sudo blkid /dev/nvme0n1 | grep -Po '(?s)(?<=UUID=").*?(?=")')
sudo cat >>/etc/fstab <<end
UUID=$UUID     /data       xfs    defaults,nofail   0   2
end
mount -a
chown splunk:splunk /data
;;
*) echo "Unexpected subnet id";;
esac

printf '%s\t%s\n' $LOCALIP 'splunk_master_license' >> /etc/hosts
hostname splunk_master_license

sudo cat >>/home/splunk/restaura_index.sh<<eof

# Restaura os Index
cd /opt/splunk/
aws s3 sync s3://${splunk_master}/configuration_files/ ./ 
chown splunk:splunk -R /opt/splunk/

eof

chmod 700 /home/splunk/restaura_index.sh
(crontab -l 2>/dev/null; echo "0 * * * * /home/splunk/restaura_index.sh -with args") | crontab -
sudo cat >>/home/splunk/splunk_temp.sh<<end1

#!/bin/bash -v

touch /home/splunk/splunk.log

if [ -d "/data" ]
then
#Movimentação do SPLUNK_DB
sudo -u splunk /opt/splunk/bin/splunk stop
sudo -u splunk cp -R /opt/splunk/var/lib/splunk /data 
sudo -u splunk rm -Rf /opt/splunk/var/lib/splunk
sudo -u splunk cat >>/opt/splunk/etc/splunk-launch.conf <<END
SPLUNK_DB=/data
END
sudo -u splunk /opt/splunk/bin/splunk start

else
echo "Diretorio Não Existe" >> /home/splunk/splunk.log
fi


sleep 60

# Alteração da senha de admin
sudo rm -f /opt/splunk/var/log/splunk/splunkd.log
sudo mv /opt/splunk/etc/passwd /opt/splunk/etc/passwd.bak
sudo cat >>/opt/splunk/etc/system/local/user-seed.conf<<end
[user_info]
USERNAME = admin
PASSWORD = $admin_pass
end

sudo sed -i '/guid/d' /opt/splunk/etc/instance.cfg
sudo -u splunk touch /opt/splunk/etc/.ui_login
sudo -u splunk /opt/splunk/bin/splunk edit user admin -password '$admin_pass' -role admin -auth admin:SPLUNK-$INSTANCEID

echo "Alteração senha Usuario" >> /home/splunk/splunk.log

sudo /opt/splunk/bin/splunk stop
sleep 60


#Alteração do ulimit do Linux e adicionando o splunk no boot-start
sudo /opt/splunk/bin/splunk disable boot-start
sudo /opt/splunk/bin/splunk enable boot-start -user splunk -systemd-managed 0

sed -i '/init.d\/functions/a ulimit -Sn 32768' /etc/init.d/splunk
sed -i '/init.d\/functions/a ulimit -Hn 65536' /etc/init.d/splunk

sudo cat >>/etc/security/limits.conf<<end
#splunk
root        soft    nofile           64000
root        hard    nofile           64000
root        hard    nproc            16000
root        hard    fsize            -1  
splunk      soft    nofile           64000
splunk      hard    nofile           64000
splunk      hard    nproc            16000
splunk      hard    fsize            -1  
 
end

echo "alteracao ulimit" >> /home/splunk/splunk.log

sudo -u splunk /opt/splunk/bin/splunk restart

echo "restart 1" >> /home/splunk/splunk.log

sleep 120

mkdir -p /opt/splunk/etc/licenses/enterprise
cd /opt/splunk/etc/licenses/enterprise
aws s3 cp s3://${splunk_itau_license}/Splunk.License ./
chown -R splunk:splunk /opt/splunk/etc/licenses/enterprise
chmod 777 /opt/splunk/etc/licenses/enterprise/Splunk.License
sudo -u splunk /opt/splunk/bin/splunk add licenses /opt/splunk/etc/licenses/enterprise/Splunk.License -auth admin:'$admin_pass'  &>> /home/splunk/splunk.log

echo "coleta da licensa" >> /home/splunk/splunk.log

sudo -u splunk /opt/splunk/bin/splunk restart
sleep 120

echo "restart 2" >> /home/splunk/splunk.log

# Aumento do tempo de timeout
mkdir -p /opt/splunk/etc/apps/base-autogenerated/local
sudo -u splunk cat >>/opt/splunk/etc/apps/base-autogenerated/local/web.conf <<end
[settings]
splunkdConnectionTimeout = 300
enableWebDebug = True
enableSplunkWebSSL = true
end

chown splunk:splunk /opt/splunk/etc/apps/base-autogenerated/local/web.conf

echo "alteracao webservice" >> /home/splunk/splunk.log


# Habilitar o index auto discovery
echo "habilita auto-discovery" >> /home/splunk/splunk.log

sudo -u splunk cat >>/opt/splunk/etc/apps/base-autogenerated/local/outputs.conf <<end

# Turn off indexing on the search head
[indexAndForward]
index = false

[tcpout]
defaultGroup = indexer_cluster_peers
forwardedindex.filter.disable = true
indexAndForward = false

[tcpout:indexer_cluster_peers]
indexerDiscovery = cluster_master

[indexer_discovery:cluster_master]
pass4SymmKey = $admin_pass
master_uri = https://$MASTER_IP:8089
end

echo "desabilita indexacao" >> /home/splunk/splunk.log

chown splunk:splunk /opt/splunk/etc/apps/base-autogenerated/local/outputs.conf
sudo -u splunk /opt/splunk/bin/splunk edit cluster-config -mode master -multisite true -replication_factor 2 -available_sites site1,site2 -site site1 -site_replication_factor origin:1,total:2 -site_search_factor origin:1,total:2 -secret '$admin_pass' -cluster_label SplunkIndexersASG -auth admin:'$admin_pass'

echo "adiciona informações do cluster" >> /home/splunk/splunk.log

sudo -u splunk  cat >>/opt/splunk/etc/system/local/server.conf <<end
[indexer_discovery]
pass4SymmKey = $admin_pass
indexerWeightByDiskCapacity = true
end

echo "cria index discovery" >> /home/splunk/splunk.log

chown -R splunk:splunk /opt/splunk/etc/system/local/server.conf
sudo -u splunk /opt/splunk/bin/splunk http-event-collector enable -uri https://localhost:8089
sudo -u splunk /opt/splunk/bin/splunk http-event-collector create default-token -uri https://localhost:8089 > /tmp/token

echo "habilitita event-collector" >> /home/splunk/splunk.log

TOKEN=`sed -n 's/\\ttoken=//p' /tmp/token` && rm /tmp/token
mkdir -p /opt/splunk/etc/master-apps/peer-base-autogenerated/local
sudo mv /opt/splunk/etc/apps/splunk_httpinput/local/inputs.conf /opt/splunk/etc/master-apps/peer-base-autogenerated/local
sudo cat >>/opt/splunk/etc/master-apps/peer-base-autogenerated/local/inputs.conf <<end
[splunktcp://9997]
disabled=0
end

chown -R splunk:splunk /opt/splunk/etc/master-apps
sudo -u splunk /opt/splunk/bin/splunk restart

echo "restart 3" >> /home/splunk/splunk.log

sleep 120

# Restaura os Index
cd /opt/splunk/
aws s3 sync s3://${splunk_master}/configuration_files/ ./
chown splunk:splunk -R /opt/splunk/

echo "coleta arquivo S3" >> /home/splunk/splunk.log
echo "restart 4" >> /home/splunk/splunk.log

sudo -u splunk /opt/splunk/bin/splunk restart

sleep 900
sudo -u splunk /opt/splunk/bin/splunk apply cluster-bundle -auth admin:'$admin_pass' --answer-yes &>> /home/splunk/splunk.log

rm -f /home/splunk/splunk_temp.sh
echo "arquivo deletado" >> /home/splunk/splunk.log

end1

chmod 777 /home/splunk/splunk_temp.sh
at -f /home/splunk/splunk_temp.sh now + 5 minute
